package rest.filemanager;


import java.io.ByteArrayInputStream;
import java.util.Date;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import rest.filemanager.model.Media;
import rest.filemanager.repository.MediaRepository;
import rest.filemanager.storage.MediaStore;
import rest.filemanager.storage.MediaStoreResponse.MediaSaveResponse;


@EnableJpaRepositories(basePackageClasses = {MediaRepository.class})
@SpringBootApplication
public class Application {

    @Bean
    public SampleDataCreator sampleDataCreator() {
        return new SampleDataCreator();
    }

    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
    
    public static class SampleDataCreator implements CommandLineRunner {
        protected final Log logger = LogFactory.getLog(getClass());

        @Autowired
        private MediaRepository mediaRepository;

        @Autowired
        private MediaStore mediaStore;
        
        public SampleDataCreator() {
        
        }

        
        @Override
        public void run(String... strings) throws Exception {
            
            if (mediaRepository.count() == 0) {
                createSampleData();
            }
            
        }

        private void createSampleData() {

            if (logger.isInfoEnabled()) {
                logger.info("Creating Sample Data");
            }
            
            mediaStore.deleteAll();
            
            String fileContents = "This is a sample data file generated by the application";
            MediaSaveResponse mediaResponse =  mediaStore.save(
                    new ByteArrayInputStream(fileContents.getBytes()), "Sample_Data.txt", "File Description");
            
            if(!mediaResponse.isSuccess()) {
                throw new RuntimeException("Unable to create sample data",mediaResponse.getException());
            }
            
            
            for(int i=0; i<100; i++) {
                Media media = new Media();
                media.setCreationDate(new Date());
                media.setTitle("Media File " + String.valueOf(i));
                media.setDescription("Media Description "  + String.valueOf(i));
                media.setOrginalFileName(mediaResponse.getMedia().getOrginalFileName());
                media.setFileSize(mediaResponse.getMedia().getFileSize());
                media.setReference(mediaResponse.getMedia().getReference());
                mediaRepository.save(media);
            }
            
             if (logger.isInfoEnabled()) {
                logger.info("Sample Data Created");
            }
        }
        
        

    }

}
